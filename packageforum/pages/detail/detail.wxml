<view class="container">
  <!-- å¸–å­è¯¦æƒ… -->
  <view class="post-detail">
    <view class="userinfo">
      <view class="userinfo-top">
        <!-- å¤´åƒ -->
        <image class="avatar" src="{{post.avatarUrl}}"></image>
        <!-- æ˜µç§° -->
        <text class="username">{{post.nickName}}</text>
      </view>
      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="post-meta">
        <text class="post-author">Uid: {{post.userId}}</text>
        <text class="post-time">æ—¶é—´ï¼š{{post.formattedTime}}</text>
      </view>
    </view>
    <!-- æ ‡é¢˜ -->
    <view class="post-title">{{post.title}}</view>
    <!-- æè¿° -->
    <view class="post-description">{{post.description}}</view>
    <!-- å›¾ç‰‡ -->
    <view class="post-images" wx:if="{{post.images.length > 0}}">
      <image
        wx:for="{{post.images}}"
        wx:key="index"
        src="{{item}}"
        mode="aspectFill"
        class="post-image"
      ></image>
    </view>

    <!-- ç‚¹èµå’Œè¯„è®º -->
    <view class="post-actions">
      <!-- ç‚¹èµæŒ‰é’® -->
      <button
        class="like-btn"
        bindtap="handleLike"
        data-post-id="{{post._id}}"
      >
        <text>ğŸ‘</text> {{post.likeCount || 0}}
      </button>
      <!-- è¯„è®ºæŒ‰é’® -->
      <button
        class="comment-btn"
        bindtap="toggleCommentSection"
        data-post-id="{{post._id}}"
      >
        <text>ğŸ’¬</text> {{post.commentCount || 0}}
      </button>
    </view>
    <!-- è¯„è®ºåŒºåŸŸ -->
    <view class="comments-section">
      <view class="comment-list">
        <block wx:for="{{comments}}" wx:key="_id">
          <view class="comment-item" data-comment-id="{{item._id}}">
            <!-- å¤´åƒ -->
            <image class="comment-avatar" src="{{item.avatarUrl}}"></image>
            <view class="comment-content-wrapper">
              <view class="comment-header">
                <!-- æ˜µç§° -->
                <text class="comment-nickname">{{item.nickName}}</text>
              </view>
              <!-- è¯„è®ºå†…å®¹ -->
              <text class="comment-content">{{item.content}}</text>
              <view class="comment-footer">
                <!-- è¯„è®ºæ—¶é—´ -->
                <text class="comment-time">{{item.formattedTime}}</text>
                <!-- å›å¤æŒ‰é’® -->
                <button class="reply-btn" bindtap="showReplyInput" data-comment-id="{{item._id}}" data-comment-author="{{item.nickName}}">
                  å›å¤
                </button>
              </view>
            </view>
          </view>
          <!-- å›å¤åˆ—è¡¨ -->
          <view class="replies-list" wx:if="{{item.replies && item.replies.length > 0}}">
            <block wx:for="{{item.isExpanded ? item.replies : [item.replies[0]]}}" wx:key="_id">
              <view class="reply-item">
                <!-- å¤´åƒ -->
                <image class="comment-avatar" src="{{item.avatarUrl}}"></image>
                <view class="comment-content-wrapper">
                  <view class="comment-header">
                    <!-- æ˜µç§° -->
                    <text class="comment-nickname">{{item.nickName}}</text>
                  </view>
                  <!-- è¯„è®ºå†…å®¹ -->
                  <text class="comment-content">{{item.content}}</text>
                  <view class="comment-footer">
                    <!-- è¯„è®ºæ—¶é—´ -->
                    <text class="comment-time">{{item.formattedTime}}</text>
                    <!-- å›å¤æŒ‰é’® -->
                    <button class="reply-btn" bindtap="showReplyInput" data-comment-id="{{item._id}}" data-comment-author="{{item.nickName}}">
                      å›å¤
                    </button>
                  </view>
                </view>
              </view>
            </block>
            <!-- å±•å¼€/æŠ˜å æŒ‰é’® -->
            <view class="reply-toggle" wx:if="{{item.replies.length > 0}}">
              <button bindtap="toggleReplyExpanded" data-comment-id="{{item._id}}" class="toggle-btn">
                {{item.isExpanded ? 'æ”¶èµ·å›å¤' : 'æŸ¥çœ‹å…¨éƒ¨å›å¤ (' + item.replies.length + ')'}}
              </button>
            </view>
          </view>

        </block>
      </view>
    </view>
  </view>
  
  <!-- å¼¹å‡ºå¼è¯„è®ºè¾“å…¥æ¡† -->
  <view class="comment-input-popup" wx:if="{{showCommentInput}}">
    <view class="comment-input-content">
      <textarea
        placeholder="å‘è¡¨è¯„è®º..."
        value="{{newComment}}"
        bindinput="onCommentInput"
        focus="{{true}}"
        auto-height="{{true}}"
        style="min-height: 120rpx;"
      />
      <view class="comment-input-buttons">
        <button bindtap="hideCommentInput" class="cancel-btn">
          å–æ¶ˆ
        </button>
        <button bindtap="handleComment" data-post-id="{{post._id}}" class="submit-btn">
          å‘è¡¨
        </button>
      </view>
    </view>
  </view>
  
  <!-- å¼¹å‡ºå¼å›å¤è¾“å…¥æ¡† -->
  <view class="comment-input-popup" wx:if="{{showReplyInput}}">
    <view class="comment-input-content">
      <textarea
        placeholder="å›å¤ {{replyTargetAuthor}}..."
        value="{{newReply}}"
        bindinput="onReplyInput"
        focus="{{true}}"
        auto-height="{{true}}"
        style="min-height: 120rpx;"
      />
      <view class="comment-input-buttons">
        <button bindtap="hideReplyInput" class="cancel-btn">
          å–æ¶ˆ
        </button>
        <button bindtap="handleReply" data-comment-id="{{replyTargetId}}" class="submit-btn">
          å›å¤
        </button>
      </view>
    </view>
  </view>
</view>